Разворачивание проекта django.

Вводное:
1) Я буду рассматривать всё, кроме БД, потому что на уровне системы с ней не должно быть проблем, как и в самом django.
2) Моя конфигурация является слегка избыточной для одного сайта в одной конфигурации, но более правильной для нескольких версии одного сайта установленных как на разных серверах, так и на одном сервере (в т.ч. и от имени разных пользователей). Эта избыточность потом может многократно окупиться, когда проектом надо будет управлять из одного места на разных серверах, переконфигурировать и т.д.
3) Я ОЧЕНЬ рекомендую не изобретать велосипедов и максимально следовать стандартам, рекомендациям и best practiсe на всех уровнях. Если хочется сделать что-то по своему, или решение кажется избыточно сложным, то вы или не разобрались в вопросе, или надо сделать усилие, которое потом окупится.
4) Все версии софта желательно фиксировать. Установка должна работать с определённой версией БД. Смена версии допускается только после полного тестирования.

В случае использования Postgres, надо учитывать, что порт postgres ничего не говорит о версии базы, которая его использует. В конфигах необходимо явным образом указывать порт и ip базы. Эти данные считается локальными данными сервера. Всегда считайте, что вы заранее их не знаете.

Это же касается портов Memcached/Redis/etc. Если есть возможность, можно использовать выделенные копии этих программ. Их порты должны входить в диапазон зарезервированных под проект портов.

Подготовка сервера.
===================

1) Питон. Только через виртуальное окружение.
Необходимо иметь возможность без проблем устанавливать разные нужные версии питона. Для этого лучше всего использовать репозиторий deadsnakes.

https://launchpad.net/~deadsnakes/+archive/ubuntu/ppa

`sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt-get update`

Установка питона версии 3.5 делается как
`apt install python3.5`

virtualenv/pip и прочие запчасти оставляю на ваше усмотрение :) Они легко даставляются по мере необходимости обычно один раз в самом начале и потом не должны приносить беспокойств, хотя, бывает всякое, например, может потребоваться поставить отдельную версию виртуального окружения для конкретной версии питона.

2) NGINX.
Никаких специальных настроек не требуется. Нужно только добавить snippet для certbot (см. дальше).
На каждый сайт один конфигурированиям файл. Сайт должен работать только через ssl. С 80 порта отдельной секцией перенаправлять на 443.

3) Certbot (https://certbot.eff.org/). Необходим для выписывания и обновления ssl-сертификатов.

`sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install certbot python-certbot-nginx`

Для его работы необходимо настроить
— его самого (/etc/letsencrypt/cli.ini). Минимум вводимой информации при выписывании сертификата без запуска отдельного сервера.
— nginx (/etc/nginx/snippets/acme.conf). Это перехватчик обращений на специальный адрес при работе с сертификатами.

Обновление сертификатов должно происходить автоматически.

Выписывание сертификата (ручной режим):
3.1) Конфиг nginx для домена надо настроить на ловлю по 80 порту с добавкой acme.conf без упоминания сертификатов. См. пример /etc/nginx/sites-avaliable/project.baz_letsencrypt.nginx.conf
3.2) Выписать сертификат

`certbot certonly -d [домен]`

Могут спросить email.

3.3) Привести конфигурированиям nginx к конечному (или изначальному виду) виду с 443 портом и сертификатами. См. пример /etc/nginx/sites-avaliable/project.baz.nginx.conf и перечитать конфиги nginx.

Сами сертификаты лежат в /etc/letsencrypt/live/[домен]/, например: /etc/letsencrypt/live/project.baz/. Это очень упрощает процесс настройки конфига nginx для сайта.


Организация проекта
===================
Я рекомендую делать это следующим образом:
/home/[user]/[проект]/[тип установки]

например,
/home/foouser/project.baz/dev/ для девелоперской версии
/home/foouser/project.baz/pro/ для боевой версии
/home/foouser/project.baz/stage/ для staging версии

— (!) Проект в репозитории ОБЯЗАН иметь requirements.txt.
— Конфиги должны храниться в папках /etc/ для своего уровня абстракции.
— Проект должен быть устроен таким образом, чтобы никакая локальная информация не содержалась в основном коде. Даже то, что будет у всех проектов одинаковым, я рекомендую выносить во внешние настройки. Никаких логинов/паролей в репозитории быть не должно. Конечная настройка проекта осуществляется локальными конфигами. Сами конфиги должны иметь права 600.

Примерный сценарий такой:
Я обычно создаю файл /home/[user]/[проект]/[тип установки]/etc/settings_local.py и линкую его в /home/[user]/[проект]/[тип установки]/[проект]/[основное приложение проекта, там, где settings.py]/settings_local.py

В самом settings.py в самом конце пишу следующее:
"""try:
    from .settings_local import *
except Exception as e:
    print('No settings_local')
    print("settings_local EXCEPTION:", e)"""

Если конфигурированиям есть, то он всё, что надо, переопределяет. Если нет, то ничего не разваливается. Это опционально. Некоторые делают эти настройки через окружение. Сам линк settings_local.py можно или исключить из репозитория, или хранить там, как симлинк на ../../etc/settings_local.py. Или создавать его явно локально. Как удобнее. Суть в том, что этот файл может со временем может перегенерироваться и хорошо бы в репозитории иметь его шаблон. Но об этом совсем отдельно, если будет интересно.

— За каждым проектом резервируется диапазон портов из разрешенных (https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BF%D0%BE%D1%80%D1%82%D0%BE%D0%B2_TCP_%D0%B8_UDP). Это диапазон 49152—65535. На одну установку я рекомендую использовать минимум 10 портов. На проект 50 портов (5 установок). Начинать с последнего нуля. Например, 60000-60009 для установки и 60000-60049. Для всех установок на всех серверах я рекомендую использовать одинаковые диапазоны портов.

— Статические данные являются частью проекта, должны содержаться в репозитории и раздаваться средствами веб-сервера (nginx).
— Media файлы проекта являются локальными данными и не должны входить в репозиторий. Соответственно, храниться должны уровень выше, чем код проекта. Это же касается данных, которые закачиваются, складируют и т.д.:

/home/[user]/[проект]/[тип установки]/media/
/home/[user]/[проект]/[тип установки]/data/

Но это не обязательно. Git может игнорировать /media/. Но при прочих равных папка проекта django не будет содержать никакой локальной информации, что неплохо и даже полезно.

— Служебный конфиг: /home/[user]/[проект]/[тип установки]/etc/env.conf. Необходим для корректной и удобной работы uwsgictl.sh и прочие служебных скриптов. Содержит в себе базовый порт (порт для работы dev-сервера), имя папки с virtualenv и путь до проекта. Его можно импортировать в shell-скрипты или удобно парсить на предмет переменных.
— Админку всегда лучше закрывать дополнительной авторизацией. Делается на уровне nginx.

1) Логи лежат в /var/log/[user]/[проект]/[тип установки] и линкуются симлинком в /home/[user]/[проект]/[тип установки]/logs/

Если используется отдельная копия какой-то программы, то логи должны ложиться в эту же папку.

Ротация логов: logrotate. Его конфиги лежат в /etc/logrotate.d/.


2) Бэкапы (если нужны) лежат в /var/backups/[user]/[проект]/[тип установки] и линкуются симлинком в /home/[user]/[проект]/[тип установки]/backups/

3) Виртуальное окружение должно лежать в папке, по которой должно быть понятна версия используемого питона. Например, /var/log/[user]/[проект]/[тип установки]/env3.5/

Установка виртуального окружения: В папке /home/[user]/[проект]/[тип установки] выполниить команду:

`python[вресия] -m venv ./env[версия]`

Активация виртуального окружения:

`env[версия]/bin/activate`

Деактивация: в любом месте сказать deactivate.

4) Тестовый запуск.
Можно сделать в режиме сервера разработки на соответствующем порту. Я обычно использую первый порт из диапазона.

`manage.py runserver 0.0.0.0:[порт]`

Если всё в порядке и проект запускается, то можно готовить среду боевого окружения.

5) Папка для pid-файлов. Находится в /var/run и её необходимо пересоздавать при перезапуске сервера. Для этого есть специальный конфиг для /usr/lib/tmpfiles.d

6) Uwsgi.
Ставится в виртуальное окружение. Могут понадобится дополнительные пакеты для системы, но это не должно представлять проблемы.
Никаких проблем быть не должно. У него один конфиг: /home/[user]/[проект]/[тип установки]/etc/uwsgi.yaml и опциональный unit для systemd.

Сейчас связка uwsgi-django работает через сокет: Например, /var/tmp/expertfilm.online-uwsgi.sock. Название его не принципиально, важно, чтобы во всех конфигах он назывался одинаково. Лежит в /var/tmp/. Специально создавать его не надо. Это не самый лучший вариант и лучше работать через порт. Следите за обновлениями.

6.1) Ручной Запуск/Остановка.
Для этого есть скрипт /home/[user]/[проект]/[тип установки]/bin/uwsgictl.sh. Если его разобрать, будет понятно, как запускать/тормозить uwsgi и как это устроено. Работать должен из под пользователя, НЕ из под root. Это может привести к сбросу доступов к логам/пидам, и из-под пользователя начнутся проблемы.

Ручной запуск/остановка должна корректно восприниматься сервисом, как штатная остановка/запуск.

6.2) Глобальное разрешение (из под рута и один раз)
Работает из файлика конфигурации службы, который надо положить в /lib/systemd/system

Разрешение

`systemctl enable [имя службы]`

Запрет

`systemctl disable [имя службы]`

например,

`systemctl enable project.baz_uwsgi`

Запрет службы не выключает её оперативно. Т.е. она просто не будет перезапускаться по падению и не будет запускаться при перезагрузке.

Сейчас сервис использует скрипт bin/uwsgictl.sh и оперирует от имени пользователя.
Сервис используется для автоматического запуска и перезапуска в случае падения.
